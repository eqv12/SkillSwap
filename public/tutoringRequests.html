<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillSwap - Post Request</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="navbar">
      <header>
        <span class="logo">SkillSwap</span>
        <nav class="navList">
          <a href="http://localhost:3000/outgoingRequests" class="register-link">Requests</a>
          <a href="http://localhost:3000/incomingRequests" class="register-link">Tutoring</a>
          <a href="http://localhost:3000/newRequest" class="register-link">Post</a>
          <a href="http://localhost:3000/dashboard" class="register-link">Dashboard</a>
        </nav>
        <div class="right" onclick="logout()">
          <img src="./resources/logouticon.svg" alt="logout Icon" />
        </div>
      </header>
    </div>

    
    <div id="req-wrapper" class="request-container">
      <h2>Incoming Requests</h2>
      <div id="toggleContainer">
        <button id="showPending">Pending Requests</button>
        <button id="showAccepted">Accepted Requests</button>

        <div id="filterContainer">
          <!-- <label for="subjectFilter">Filter: </label> -->
          <select id="subjectFilter" onchange="filterRequestsBySubject()">
            <option value="">--Select Subject--</option>
            <!-- Dropdown options will be populated here dynamically -->
          </select>
        </div>
      </div>

      
      <div id="inReq-list" >
      
      </div>
    </div>

    <script>
      let status = 'Pending';
      async function fetchIncomingRequests() {
        try {
          
          const response = await fetch(`http://localhost:3000/api/incomingRequests?status=${status}`);
          const inRequestsData = await response.json();
          console.log(inRequestsData);

          const subjects = new Set();
          inRequestsData.forEach(request => {
            subjects.add(request.skillName);
          })

          const uniqueSubjArr = [...subjects]
          console.log("&&&&", uniqueSubjArr)
          populateFilterDropdown(uniqueSubjArr)


          // <label><strong>Request Date:</strong> ${reqTime}</label><br>
          const inRequestslist = document.getElementById("inReq-list");
          inRequestslist.innerHTML = '';

          if (inRequestsData.length === 0) {
            inRequestslist.innerHTML = "<p>No Incoming Requests available. </p>";
          } else {
            inRequestsData.forEach((request) => {
              const inReqdiv = document.createElement("div");
              inReqdiv.classList.add("individual-request-container");
              inReqdiv.setAttribute("data-subject", request.skillName);

              inReqdiv.innerHTML = `<label><strong>SkillId:</strong> ${request.skillId}</label><br>
              <label><strong>skillName:</strong> ${request.skillName}</label><br>
              <label><strong>SenderId:</strong> ${request.senderId}</label><br>
              <label><strong>Title:</strong> ${request.title}</label><br>
              <label><strong>Description:</strong> ${request.descr}</label><br>
              <label><strong>Status:</strong> ${request.status}</label><br>
              <label><strong>Sender Name:</strong> ${request.senderName}</label><br>
              ${request.phoneVisible ?`<label><strong>Sender Ph.No:</strong> ${request.senderPhone}</label><br>`:""}
              <label><strong>Request Date:</strong> ${request.timestamp}</label><br><br>
               
              <button class="acceptBtn tutor-btns" onclick="acceptRequest('${request.reqId}', this)">Accept</button>
              <button class="rejectBtn tutor-btns" onclick="rejectRequest('${request.reqId}', this)">Reject</button>`;

              console.log(request.descr, request.status);
              if (request.status == 'Accepted'){
                let tutorBtns = inReqdiv.getElementsByClassName("tutor-btns");
                Array.from(tutorBtns).forEach(btn => btn.style.display = 'none');
              }

              inRequestslist.appendChild(inReqdiv);
            });
          }
        } catch (error) {
          console.error("Error in fetching requests: ", error);
          const inRequestslist = document.getElementById("inReq-list");
          inRequestslist.innerHTML = "<p>Failed to load incoming requests. please try again later.</p>";
        }
      }

      window.onload = fetchIncomingRequests;

      async function acceptRequest(reqId, button) {
        try {
          const response = await fetch(`/api/request/${reqId}/accept`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });

          if (response.ok) {
            button.disabled = true;
            const rejectBtn = button.nextElementSibling;
            rejectBtn.disabled = true;

            // const requestDiv = button.parentElement;
            rejectBtn.insertAdjacentHTML("afterend", "    Request accepted");
          }
        } catch (error) {
          console.error("Error accepting request: ", error);
        }
      }

      function populateFilterDropdown(subjects){
        const filterDropdown = document.getElementById('subjectFilter');
        filterDropdown.innerHTML = '';
        const defaultOpt = document.createElement("option");
        defaultOpt.value = '--Select Subject--';
        defaultOpt.textContent = '--Select Subject--';
        filterDropdown.appendChild(defaultOpt);


        subjects.forEach(subject => {
          const option = document.createElement("option");
          option.value = subject;
          option.textContent = subject;
          filterDropdown.appendChild(option);
        })
      }

      function filterBySubject(selectedSubj){
        const inRequestslist = document.getElementById("inReq-list");
        const allRequests = inRequestslist.getElementsByClassName("individual-request-container");

        Array.from(allRequests).forEach(reqDiv => {
          const reqSubj = reqDiv.getAttribute("data-subject");
          if (selectedSubj === '--Select Subject--' || reqSubj == selectedSubj){
            reqDiv.style.display = 'block';
          }
          else {
            reqDiv.style.display = 'none';
          }
        })
      }

      document.getElementById("subjectFilter").addEventListener("change", function(event){
        const selectedSubj = event.target.value;
        filterBySubject(selectedSubj);
      });

      document.getElementById("showAccepted").addEventListener("click", function() {
        document.getElementById("showAccepted").style.backgroundColor = "green";
        document.getElementById("showPending").style.backgroundColor = "#d087e4";
        status = "Accepted";
        fetchIncomingRequests();
      })

      document.getElementById("showPending").addEventListener("click", function() {
        document.getElementById("showAccepted").style.backgroundColor = "#d087e4";
        document.getElementById("showPending").style.backgroundColor = "green";
        status = "Pending";
        fetchIncomingRequests();
      })

      async function rejectRequest(reqId, button) {
        try {
          // console.log("html")
          const response = await fetch("http://localhost:3000/api/request/reject", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ reqId: reqId }),
          });
          console.log(response);
          if (response.ok) {
            button.disabled = true;
            const acceptBtn = button.previousElementSibling;
            acceptBtn.disabled = true;

            // const requestDiv = button.parentElement;
            button.insertAdjacentHTML("afterend", "    Request rejected");
          }
        } catch (error) {
          console.error("Error accepting request: ", error);
        }
      }

      async function logout() {
        try {
          const response = await fetch("/logout", {
            method: "POST",
            credentials: "include",
          });
          console.log(response);
          if (response.status === 200) {
            window.location.href = "http://localhost:3000/login";
          } else {
            console.error("Logout failed:", response.statusText);
          }
        } catch (error) {
          console.error("Error during logout:", error);
        }
      }
    </script>
  </body>
</html>
